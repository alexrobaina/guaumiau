import React, { useState } from 'react';
import {
  View,
  ScrollView,
  Image,
  TouchableOpacity,
  ActivityIndicator,
} from 'react-native';
import { RouteProp, useRoute, useNavigation } from '@react-navigation/native';
import {
  ArrowLeft,
  Pencil,
  Heart,
  Activity,
  Cross,
  CheckCircle,
  XCircle,
  AlertTriangle,
  Pill,
  PawPrint,
  Clock,
  ToyBrick,
  Utensils,
  Phone,
  ChevronDown,
  ChevronUp,
  Camera,
  MessageCircle,
} from 'lucide-react-native';
import { Text } from '@/components/atoms/Text';
import { MainStackParamList } from '@/navigation/types';
import { usePet } from '@/hooks/api/usePet';
import { EnergyLevel, PetGender, PetSize } from '@/types/pet.types';
import { styles } from './styles';
import { theme } from '@/theme';

type PetProfileScreenRouteProp = RouteProp<MainStackParamList, 'PetProfile'>;

// Helper functions to format data
const formatGender = (gender: PetGender): string => {
  const labels = {
    [PetGender.MALE]: 'Male',
    [PetGender.FEMALE]: 'Female',
    [PetGender.UNKNOWN]: 'Unknown',
  };
  return labels[gender] || 'Unknown';
};

const formatSize = (size: PetSize): string => {
  const labels = {
    [PetSize.EXTRA_SMALL]: 'Extra Small',
    [PetSize.SMALL]: 'Small',
    [PetSize.MEDIUM]: 'Medium',
    [PetSize.LARGE]: 'Large',
    [PetSize.EXTRA_LARGE]: 'Extra Large',
  };
  return labels[size] || 'Medium';
};

const formatEnergyLevel = (level?: EnergyLevel | null): string => {
  if (!level) return 'Unknown';
  const labels = {
    [EnergyLevel.LOW]: 'Low',
    [EnergyLevel.MODERATE]: 'Moderate',
    [EnergyLevel.HIGH]: 'High',
    [EnergyLevel.VERY_HIGH]: 'Very High',
  };
  return labels[level] || 'Unknown';
};

const getPhotoUrl = (photoPath?: string): string => {
  if (!photoPath) return 'https://images.unsplash.com/photo-1548199973-03cce0bbc87b?w=400&h=400&fit=crop';
  if (photoPath.startsWith('http')) return photoPath;
  return `http://127.0.0.1:3000${photoPath}`;
};

export function PetProfileScreen() {
  const route = useRoute<PetProfileScreenRouteProp>();
  const navigation = useNavigation();
  const { petId } = route.params;

  const [careExpanded, setCareExpanded] = useState(false);

  const { data: pet, isLoading, isError, error, refetch } = usePet(petId);

  if (isLoading) {
    return (
      <View style={styles.centerContainer}>
        <ActivityIndicator size="large" color={theme.colors.primary} />
        <Text variant="body" color="textSecondary" style={styles.centerText}>
          Loading pet profile...
        </Text>
      </View>
    );
  }

  if (isError || !pet) {
    return (
      <View style={styles.centerContainer}>
        <AlertTriangle size={48} color={theme.colors.error} />
        <Text variant="body" color="error" style={styles.centerText}>
          Error loading pet profile
        </Text>
        <Text variant="caption" color="textSecondary" style={styles.centerText}>
          {error?.response?.data?.message || error?.message || 'Pet not found'}
        </Text>
        <TouchableOpacity
          style={styles.retryButton}
          onPress={() => refetch()}
          activeOpacity={0.7}
        >
          <Text variant="body" style={styles.retryButtonText}>
            Retry
          </Text>
        </TouchableOpacity>
      </View>
    );
  }

  // Format data from backend
  const heroImage = getPhotoUrl(pet.photos?.[0]);
  const profileImage = getPhotoUrl(pet.photos?.[0]);
  const gender = formatGender(pet.gender);
  const size = formatSize(pet.size);
  const energyLevel = formatEnergyLevel(pet.energyLevel);

  // Parse text fields that might contain JSON arrays or comma-separated values
  const parseListField = (field?: string | null): string[] => {
    if (!field) return [];
    try {
      const parsed = JSON.parse(field);
      return Array.isArray(parsed) ? parsed : [];
    } catch {
      return field.split(',').map(s => s.trim()).filter(Boolean);
    }
  };

  const allergies = parseListField(pet.allergies);
  const medications = parseListField(pet.medications);
  const favoriteActivities = parseListField(pet.favoriteActivities);

  return (
    <View style={styles.container}>
      {/* Header with Hero Image */}
      <View style={styles.heroContainer}>
        <Image source={{ uri: heroImage }} style={styles.heroImage} />
        <View style={styles.heroOverlay} />

        {/* Header Buttons */}
        <View style={styles.headerButtons}>
          <TouchableOpacity
            style={styles.headerButton}
            onPress={() => navigation.goBack()}
            activeOpacity={0.7}
          >
            <ArrowLeft size={20} color={theme.colors.text} />
          </TouchableOpacity>
          <TouchableOpacity
            style={styles.headerButton}
            onPress={() => console.log('Edit pet', pet.id)}
            activeOpacity={0.7}
          >
            <Pencil size={20} color={theme.colors.primary} />
          </TouchableOpacity>
        </View>

        {/* Profile Photo Overlay */}
        <View style={styles.profilePhotoContainer}>
          <Image source={{ uri: profileImage }} style={styles.profilePhoto} />
        </View>
      </View>

      <ScrollView style={styles.scrollView} showsVerticalScrollIndicator={false}>
        {/* Pet Identity Section */}
        <View style={styles.identitySection}>
          <Text variant="h1" style={styles.petName}>
            {pet.name}
          </Text>
          <Text variant="body" color="textSecondary" style={styles.petBreed}>
            {pet.breed || 'Unknown breed'}
          </Text>

          <View style={styles.badgesRow}>
            <View
              style={[
                styles.genderBadge,
                pet.gender === PetGender.MALE ? styles.maleBadge : styles.femaleBadge,
              ]}
            >
              <Text variant="caption" style={styles.badgeWhiteText}>
                {gender}
              </Text>
            </View>
            {pet.age && (
              <View style={[styles.genderBadge, styles.ageBadge]}>
                <Text variant="caption" style={styles.badgeWhiteText}>
                  {pet.age} years
                </Text>
              </View>
            )}
            <View style={[styles.genderBadge, styles.sizeBadge]}>
              <Text variant="caption" style={styles.badgeWhiteText}>
                {size}
              </Text>
            </View>
          </View>
        </View>

        {/* Quick Stats Grid */}
        <View style={styles.statsGrid}>
          <View style={styles.statBox}>
            <Text style={styles.statNumber}>{pet.weight || 'N/A'}</Text>
            <Text style={styles.statLabel}>kg</Text>
          </View>
          <View style={styles.statBox}>
            <Activity size={20} color={theme.colors.primary} />
            <Text style={styles.statLabel}>{energyLevel}</Text>
          </View>
          <View style={styles.statBox}>
            <Heart size={20} color={theme.colors.primary} />
            <Text style={styles.statLabel}>Friendly</Text>
          </View>
        </View>

        {/* Medical Information Card */}
        <View style={styles.card}>
          <View style={styles.cardHeader}>
            <Cross size={20} color={theme.colors.primary} />
            <Text variant="h2" style={styles.cardTitle}>
              Medical Information
            </Text>
          </View>

          <View style={styles.infoRow}>
            <Text variant="body" color="text">
              Vaccination Status
            </Text>
            {pet.isVaccinated ? (
              <CheckCircle size={20} color={theme.colors.success} />
            ) : (
              <XCircle size={20} color={theme.colors.error} />
            )}
          </View>

          <View style={styles.infoRow}>
            <Text variant="body" color="text">
              Neutered
            </Text>
            <View style={styles.badgeGreen}>
              <Text variant="caption" style={styles.badgeTextGreen}>
                {petData.medical.neutered ? 'Yes' : 'No'}
              </Text>
            </View>
          </View>

          <View style={styles.infoRow}>
            <Text variant="body" color="text">
              Microchip ID
            </Text>
            <Text variant="caption" color="textSecondary">
              {petData.medical.microchipId}
            </Text>
          </View>

          <View style={styles.infoRow}>
            <Text variant="body" color="text">
              Last Vet Visit
            </Text>
            <Text variant="caption" color="textSecondary">
              {petData.medical.lastVetVisit}
            </Text>
          </View>

          {petData.medical.allergies.length > 0 && (
            <View style={styles.subsection}>
              <View style={styles.subsectionHeader}>
                <AlertTriangle size={16} color={theme.colors.error} />
                <Text variant="body" style={styles.subsectionTitle}>
                  Allergies
                </Text>
              </View>
              <View style={styles.tagsContainer}>
                {petData.medical.allergies.map((allergy, index) => (
                  <View key={index} style={styles.badgeRed}>
                    <Text variant="caption" style={styles.badgeTextRed}>
                      {allergy}
                    </Text>
                  </View>
                ))}
              </View>
            </View>
          )}

          {petData.medical.medications.length > 0 && (
            <View style={styles.subsection}>
              <View style={styles.subsectionHeader}>
                <Pill size={16} color={theme.colors.primary} />
                <Text variant="body" style={styles.subsectionTitle}>
                  Current Medications
                </Text>
              </View>
              <View style={styles.listContainer}>
                {petData.medical.medications.map((med, index) => (
                  <Text key={index} variant="body" color="textSecondary">
                    • {med}
                  </Text>
                ))}
              </View>
            </View>
          )}
        </View>

        {/* Behavioral Traits Section */}
        <View style={styles.card}>
          <View style={styles.cardHeader}>
            <PawPrint size={20} color={theme.colors.primary} />
            <Text variant="h2" style={styles.cardTitle}>
              Behavior & Training
            </Text>
          </View>

          <View style={styles.behaviorGrid}>
            <View
              style={[
                styles.behaviorChip,
                petData.behavior.goodWithKids ? styles.behaviorActive : styles.behaviorInactive,
              ]}
            >
              <Text
                variant="caption"
                style={
                  petData.behavior.goodWithKids ? styles.behaviorActiveText : styles.behaviorInactiveText
                }
              >
                Good with kids
              </Text>
            </View>
            <View
              style={[
                styles.behaviorChip,
                petData.behavior.goodWithPets ? styles.behaviorActive : styles.behaviorInactive,
              ]}
            >
              <Text
                variant="caption"
                style={
                  petData.behavior.goodWithPets ? styles.behaviorActiveText : styles.behaviorInactiveText
                }
              >
                Good with pets
              </Text>
            </View>
            <View
              style={[
                styles.behaviorChip,
                petData.behavior.houseTrained ? styles.behaviorActive : styles.behaviorInactive,
              ]}
            >
              <Text
                variant="caption"
                style={
                  petData.behavior.houseTrained ? styles.behaviorActiveText : styles.behaviorInactiveText
                }
              >
                House trained
              </Text>
            </View>
            <View
              style={[
                styles.behaviorChip,
                petData.behavior.leashTrained ? styles.behaviorActive : styles.behaviorInactive,
              ]}
            >
              <Text
                variant="caption"
                style={
                  petData.behavior.leashTrained ? styles.behaviorActiveText : styles.behaviorInactiveText
                }
              >
                Leash trained
              </Text>
            </View>
          </View>

          <View style={styles.subsection}>
            <Text variant="body" style={styles.subsectionTitle}>
              Known Commands
            </Text>
            <View style={styles.tagsContainer}>
              {petData.behavior.commands.map((command, index) => (
                <View key={index} style={styles.badgeOrange}>
                  <Text variant="caption" style={styles.badgeTextOrange}>
                    {command}
                  </Text>
                </View>
              ))}
            </View>
          </View>
        </View>

        {/* Preferences Card */}
        <View style={styles.card}>
          <Text variant="h2" style={styles.cardTitle}>
            Preferences
          </Text>

          <View style={styles.preferenceSection}>
            <View style={styles.preferenceHeader}>
              <Activity size={16} color={theme.colors.primary} />
              <Text variant="body" style={styles.preferenceTitle}>
                Favorite Activities
              </Text>
            </View>
            <View style={styles.listContainer}>
              {petData.preferences.activities.map((activity, index) => (
                <View key={index} style={styles.listItem}>
                  <Text variant="body" color="primary">
                    •
                  </Text>
                  <Text variant="body" color="textSecondary" style={styles.listItemText}>
                    {activity}
                  </Text>
                </View>
              ))}
            </View>
          </View>

          <View style={styles.preferenceSection}>
            <View style={styles.preferenceHeader}>
              <Clock size={16} color={theme.colors.primary} />
              <Text variant="body" style={styles.preferenceTitle}>
                Preferred Walk Duration
              </Text>
            </View>
            <Text variant="body" color="primary">
              {petData.preferences.walkDuration}
            </Text>
          </View>

          <View style={styles.preferenceSection}>
            <View style={styles.preferenceHeader}>
              <ToyBrick size={16} color={theme.colors.primary} />
              <Text variant="body" style={styles.preferenceTitle}>
                Favorite Toys
              </Text>
            </View>
            <View style={styles.listContainer}>
              {petData.preferences.favoriteToys.map((toy, index) => (
                <View key={index} style={styles.listItem}>
                  <Text variant="body" color="primary">
                    •
                  </Text>
                  <Text variant="body" color="textSecondary" style={styles.listItemText}>
                    {toy}
                  </Text>
                </View>
              ))}
            </View>
          </View>

          <View style={styles.preferenceSection}>
            <View style={styles.preferenceHeader}>
              <Utensils size={16} color={theme.colors.primary} />
              <Text variant="body" style={styles.preferenceTitle}>
                Dietary Restrictions
              </Text>
            </View>
            <View style={styles.tagsContainer}>
              {petData.preferences.dietaryRestrictions.map((restriction, index) => (
                <View key={index} style={styles.badgeRed}>
                  <Text variant="caption" style={styles.badgeTextRed}>
                    {restriction}
                  </Text>
                </View>
              ))}
            </View>
          </View>
        </View>

        {/* Emergency Contact Section */}
        <View style={[styles.card, styles.emergencyCard]}>
          <Text variant="h2" style={styles.emergencyTitle}>
            Emergency Contact
          </Text>

          <Text variant="h3" style={styles.emergencyClinic}>
            {petData.emergency.clinicName}
          </Text>
          <Text variant="body" color="text" style={styles.emergencyVet}>
            {petData.emergency.vetName}
          </Text>
          <Text variant="body" color="primary" style={styles.emergencyPhone}>
            {petData.emergency.phone}
          </Text>
          <Text variant="caption" color="textSecondary" style={styles.emergencyAddress}>
            {petData.emergency.address}
          </Text>

          <TouchableOpacity style={styles.emergencyButton} activeOpacity={0.7}>
            <Phone size={20} color="#fff" />
            <Text variant="body" style={styles.emergencyButtonText}>
              Call Vet
            </Text>
          </TouchableOpacity>
        </View>

        {/* Care Instructions */}
        <View style={styles.card}>
          <TouchableOpacity
            onPress={() => setCareExpanded(!careExpanded)}
            style={styles.expandableHeader}
            activeOpacity={0.7}
          >
            <Text variant="h2" style={styles.cardTitle}>
              Special Care Instructions
            </Text>
            {careExpanded ? (
              <ChevronUp size={20} color={theme.colors.primary} />
            ) : (
              <ChevronDown size={20} color={theme.colors.primary} />
            )}
          </TouchableOpacity>

          {careExpanded && (
            <View style={styles.careInstructionsContent}>
              <Text variant="body" color="text" style={styles.careInstructionsText}>
                {petData.careInstructions}
              </Text>
            </View>
          )}
        </View>

        {/* Photo Gallery */}
        <View style={styles.card}>
          <Text variant="h2" style={styles.cardTitle}>
            Photos
          </Text>

          <ScrollView horizontal showsHorizontalScrollIndicator={false} style={styles.photoGallery}>
            {petData.photos.map((photo, index) => (
              <Image key={index} source={{ uri: photo }} style={styles.galleryPhoto} />
            ))}
            <TouchableOpacity style={styles.addPhotoButton} activeOpacity={0.7}>
              <Camera size={24} color={theme.colors.primary} />
            </TouchableOpacity>
          </ScrollView>
        </View>

        <View style={{ height: 100 }} />
      </ScrollView>

      {/* Bottom Action Bar */}
      <View style={styles.bottomBar}>
        <Image source={{ uri: petData.owner.avatar }} style={styles.ownerAvatar} />
        <Text variant="caption" color="text" style={styles.ownerName}>
          {petData.owner.name}
        </Text>
        <View style={styles.bottomActions}>
          <TouchableOpacity style={styles.primaryButton} activeOpacity={0.7}>
            <Text variant="body" style={styles.primaryButtonText}>
              Book Walk
            </Text>
          </TouchableOpacity>
          <TouchableOpacity style={styles.messageButton} activeOpacity={0.7}>
            <MessageCircle size={20} color={theme.colors.primary} />
          </TouchableOpacity>
        </View>
      </View>
    </View>
  );
}
